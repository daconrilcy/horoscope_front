# Epic 14 Retrospective ‚Äî G√©ocodage du lieu de naissance et pr√©cision astronomique

**Date :** 2026-02-22  
**Participants :** √âquipe de d√©veloppement (Dev Agents + Cyril)  
**FRs couverts :** FR3, FR4, FR5, FR10, FR11, FR14, FR15

---

## R√©sum√© de l'Epic

L'Epic 14 a enrichi le profil natal avec la g√©olocalisation pr√©cise via Nominatim (OpenStreetMap), la gestion des modes d√©grad√©s (heure/lieu absents), et l'internationalisation des termes astrologiques.

- **Story 14.1** : Refonte formulaire profil natal ‚Äî ville, pays et g√©ocodage Nominatim
- **Story 14.2** : Modes d√©grad√©s ‚Äî lieu absent et heure de naissance absente
- **Story 14.3** : Table de traduction des termes astrologiques (FR/EN/ES)

---

## Ce qui a bien fonctionn√© ‚úÖ

### 1. Int√©gration Nominatim robuste
Le service de g√©ocodage `geocoding.ts` respecte les contraintes Nominatim :
- User-Agent obligatoire
- Timeout 10s avec AbortController
- Gestion des erreurs (lieu introuvable vs service indisponible)
- Encodage correct des caract√®res sp√©ciaux (accents, apostrophes, japonais)

### 2. Modes d√©grad√©s bien document√©s et test√©s
La gestion de `degraded_mode` (no_location, no_time, no_location_no_time) est coh√©rente entre backend et frontend :
- Bandeaux d'avertissement clairs avec `role="alert"`
- Checkbox "Heure inconnue" intuitive
- Tests exhaustifs (8 tests sp√©cifiques)

### 3. Module i18n extensible sans d√©pendance externe
Le hook `useAstrologyLabels()` avec `useState`/`useEffect` offre :
- R√©activit√© aux changements de `localStorage`
- Sync entre onglets via √©v√©nement `storage`
- Fonctions bound (pas besoin de passer `lang` √† chaque appel)
- Fallback gracieux pour les codes inconnus

### 4. Dictionnaires complets
69 tests unitaires couvrent l'ensemble des traductions (12 signes √ó 3 langues, 10 plan√®tes √ó 3, 12 maisons √ó 3, 9 aspects √ó 3).

---

## Ce qui peut √™tre am√©lior√© ‚ö†Ô∏è

### 1. Coordination frontend/backend pour les nouveaux champs
Les champs `birth_city`, `birth_country`, `birth_lat`, `birth_lon` ont √©t√© ajout√©s c√¥t√© frontend mais la story ne pr√©cisait pas si le backend √©tait d√©j√† pr√™t.

**Action :** Inclure une v√©rification explicite de l'√©tat du backend dans les pr√©-requis des stories frontend.

### 2. Plusieurs rounds de code review n√©cessaires
- Story 14.1 : 3 rounds
- Story 14.2 : 3 rounds  
- Story 14.3 : 5 rounds

Les issues d√©couvertes incluaient : bouton non d√©sactiv√© quand champs vides, protection NaN, hook conditionnel, etc.

**Action :** Renforcer les crit√®res de "definition of done" pour r√©duire les allers-retours.

### 3. Documentation des sentinelles pour modes d√©grad√©s
Les valeurs sentinelles (`"00:00"` pour heure inconnue, cha√Æne vide pour lieu) n'√©taient pas document√©es initialement.

**Action :** Documenter les valeurs sentinelles dans le contrat API et les constantes.

---

## Le√ßons apprises üìö

| Le√ßon | Recommandation |
|-------|----------------|
| Nominatim requiert User-Agent explicite et rate limiting | Documenter les contraintes API externes dans les stories |
| La d√©rivation signe depuis longitude est une formule r√©currente | Extraire dans une fonction utilitaire (fait : `_longitude_to_sign`) |
| Les hooks React doivent utiliser useState pour la r√©activit√© | Ne pas utiliser de simples objets JS pour les √©tats dynamiques |
| L'encodage URL doit √™tre test√© avec des cas edge (accents, japonais) | Ajouter des tests d'encodage syst√©matiquement |
| Le cleanup via `useEffect` return est essentiel pour les AbortController | Pattern √† documenter dans les conventions frontend |

---

## M√©triques

| M√©trique | Valeur |
|----------|--------|
| Stories compl√©t√©es | 3/3 (100%) |
| Tests ajout√©s | 82 (15 geocoding + 12 BirthProfile g√©ocodage + 10 NatalChart degraded + 69 i18n + 13 NatalChart i18n) |
| Rounds de code review | 11 total (3 + 3 + 5) |
| Nouveaux fichiers | 3 (geocoding.ts, astrology.ts, geocodingApi.test.ts, astrology-i18n.test.ts) |
| Lint errors final | 0 |

---

## Highlights techniques

### Service de g√©ocodage
- Timeout 10s avec AbortController
- Signal externe pour annulation par l'appelant
- Validation `isFinite()` sur les coordonn√©es pour √©viter NaN

### Hook i18n
- Vrai hook React avec √©tat (pas un simple objet)
- R√©activit√© via √©v√©nement `storage` pour sync entre onglets
- `setLang()` persiste dans `localStorage` ET met √† jour l'√©tat

### Protection des modes d√©grad√©s
- Protection nullish `?? []` sur `planet_positions`, `houses`, `aspects`
- Constantes `UNKNOWN_BIRTH_TIME_SENTINEL` et `UNKNOWN_LOCATION_SENTINELS`

---

## Actions pour les prochains sprints

1. [ ] **Documentation des valeurs sentinelles** ‚Äî Ajouter dans le README API les valeurs sp√©ciales pour modes d√©grad√©s
2. [ ] **Pattern AbortController** ‚Äî Documenter le pattern de cleanup dans les conventions frontend
3. [ ] **Validation des coordonn√©es** ‚Äî Appliquer `isFinite()` partout o√π des coordonn√©es sont pars√©es
4. [ ] **i18n : ajouter l'allemand** ‚Äî La structure est pr√™te, il suffit d'ajouter les traductions

---

**Status :** Epic 14 ‚úÖ Done
