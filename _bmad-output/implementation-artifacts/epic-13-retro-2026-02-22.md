# Epic 13 Retrospective ‚Äî Stabilisation post-MVP : corrections des flux critiques

**Date :** 2026-02-22  
**Participants :** √âquipe de d√©veloppement (Dev Agents + Cyril)  
**FRs couverts :** FR10, FR11 (correction de r√©gression)

---

## R√©sum√© de l'Epic

L'Epic 13 √©tait un sprint de stabilisation cibl√© sur un bug bloquant d√©couvert en test manuel : l'erreur 422 lors de la g√©n√©ration du th√®me natal. Une seule story a √©t√© n√©cessaire pour r√©soudre le probl√®me et renforcer la robustesse du parsing d'erreurs.

- **Story 13.1** : Correction erreur 422 lors de la g√©n√©ration du th√®me natal

---

## Ce qui a bien fonctionn√© ‚úÖ

### 1. Diagnostic pr√©cis de la cause racine
Le bug a √©t√© rapidement identifi√© :
- **Cause primaire** : `Content-Type: application/json` manquant dans `generateNatalChart`
- **Cause secondaire** : `handleResponse` ne parsait pas le format FastAPI natif `{"detail": [...]}`

### 2. Fix minimal et cibl√©
Le correctif a touch√© exactement 4 fichiers avec un diff minimal :
- `natalChart.ts` : ajout du header + fallback 422 parsing
- `BirthProfilePage.tsx` : gestion UX du code `unprocessable_entity`
- Tests associ√©s

### 3. Tests couvrant les deux formats d'erreur
Les nouveaux tests v√©rifient √† la fois le format standard `{"error": {...}}` et le format FastAPI natif `{"detail": [...]}`, √©vitant les r√©gressions futures.

### 4. Body vide JSON explicite
Le hotfix pour ajouter `body: JSON.stringify({})` dans le POST (m√™me si le corps est techniquement vide) a r√©solu le dernier edge case FastAPI.

---

## Ce qui peut √™tre am√©lior√© ‚ö†Ô∏è

### 1. Bug introduit lors du d√©veloppement initial
Le header `Content-Type` aurait d√ª √™tre pr√©sent d√®s le d√©part. Le pattern existait dans `saveBirthData` mais n'a pas √©t√© reproduit dans `generateNatalChart`.

**Action :** Cr√©er un helper centralis√© pour les requ√™tes POST JSON (`postJson(url, body?)`) qui inclut automatiquement le header.

### 2. Format d'erreur FastAPI non anticip√©
Le format natif FastAPI `{"detail": [...]}` n'√©tait pas document√© dans le contrat API, causant un `unknown_error` c√¥t√© client.

**Action :** Documenter les deux formats d'erreur possibles dans les contrats API et les g√©rer syst√©matiquement c√¥t√© frontend.

### 3. Tests manuels tardifs
Le bug a √©t√© d√©couvert tardivement en test manuel, apr√®s que les stories 12.1/12.2 aient √©t√© marqu√©es "done".

**Action :** Int√©grer des tests e2e automatis√©s sur les parcours critiques (inscription ‚Üí profil ‚Üí g√©n√©ration).

---

## Le√ßons apprises üìö

| Le√ßon | Recommandation |
|-------|----------------|
| FastAPI retourne 422 m√™me pour un POST avec body vide sans Content-Type | Toujours inclure `Content-Type: application/json` + body `{}` |
| Le format d'erreur FastAPI natif diff√®re du format standard API | Impl√©menter un fallback pour les deux formats dans `handleResponse` |
| Les patterns doivent √™tre copi√©s exactement entre fonctions similaires | Extraire les patterns communs dans des helpers r√©utilisables |
| L'assertion de bouton r√©activ√© est essentielle pour les AC | Inclure syst√©matiquement la v√©rification de l'√©tat post-erreur dans les tests |

---

## M√©triques

| M√©trique | Valeur |
|----------|--------|
| Stories compl√©t√©es | 1/1 (100%) |
| Temps de diagnostic | < 30 min |
| Fichiers modifi√©s | 4 |
| Tests ajout√©s | 5 (1 BirthProfilePage + 4 natalChartApi) |
| Rounds de code review | 2 |
| Bugs corrig√©s en review | 2 (M1 assertion bouton, L1 fallback msg vide) |
| Lint errors final | 0 |

---

## Actions pour les prochains sprints

1. [ ] **Helper `postJson()` centralis√©** ‚Äî Cr√©er dans `frontend/src/api/utils.ts` un helper qui g√®re automatiquement `Content-Type` et `body: {}`
2. [ ] **Tests e2e Playwright** ‚Äî Ajouter un test e2e pour le parcours complet inscription ‚Üí profil natal ‚Üí g√©n√©ration
3. [ ] **Documentation format erreurs** ‚Äî Mettre √† jour les contrats API pour inclure les deux formats d'erreur possibles (standard + FastAPI natif)

---

**Status :** Epic 13 ‚úÖ Done
