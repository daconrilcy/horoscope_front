# Story 9.2: Pack de verification securite (SAST/deps/pentest)

Status: review
<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a security engineer,  
I want executer des controles securite standardises,  
so that les vulnerabilites soient identifiees et traitees.

## Acceptance Criteria

1. Given la base de code et ses dependances, when les scans securite sont executes, then les findings sont classes par severite et traces.
2. Given les findings identifies, when les points critiques sont analyses, then un plan de remediation priorise est etabli pour les points critiques.

## Tasks / Subtasks

- [x] Etablir le pack de controles securite cible (AC: 1)
  - [x] Definir les categories de scans: SAST, dependances (SCA), verification pentest-ready
  - [x] Definir les outils retenus et leur mode d execution (local/CI)
  - [x] Definir un format de sortie standardise (severite, composant, evidence, remediation)
- [x] Integrer les scans SAST dans le workflow qualite (AC: 1)
  - [x] Ajouter une commande/scripts SAST reproductible pour backend et frontend
  - [x] Integrer le scan SAST au `quality-gate` et au predeploy
  - [x] Definir les regles de fail gate sur severite (ex: bloque sur High/Critical)
- [x] Integrer les scans dependances (SCA) et vuln CVE (AC: 1)
  - [x] Ajouter les scans dependances Python et Node
  - [x] Harmoniser la severite et dedoublonner les findings entre outils
  - [x] Archiver les rapports de scan pour auditabilite
- [x] Produire la base pentest-ready et les preuves minimales (AC: 1, 2)
  - [x] Documenter la check-list de pre-pentest (auth, rate limiting, secrets, endpoints sensibles)
  - [x] Lister les scenarios de test offensif prioritaires (auth, privacy, b2b, billing)
  - [x] Produire un artefact de synthese securite exploitable par ops/compliance
- [x] Construire le plan de remediation critique (AC: 2)
  - [x] Classer les findings critiques par impact/exploitabilite
  - [x] Affecter proprietaire, delai, strategie de correction
  - [x] Definir verification post-correction (re-scan + non-regression)
- [x] Couvrir par tests et non-regressions (AC: 1, 2)
  - [x] Ajouter tests/scripts validant l execution des scans dans CI/local
  - [x] Verifier qu un finding critique declenche bien un echec de gate
  - [x] Verifier qu un finding corrige n est plus present au re-scan

## Dev Notes

- Story source: `_bmad-output/planning-artifacts/epics.md` (Epic 9, Story 9.2)
- Story precedente: `9-1-durcissement-de-la-gestion-des-secrets-et-rotation.md` (actuellement en review), deja utile pour:
  - scan repository anti-secrets,
  - durcissement quality-gate,
  - runbook rotation/secrets.
- Cette story etend la securite vers un pack complet de verification continue (SAST/SCA/pentest-ready).

### Technical Requirements

- Les scans doivent etre automatisables en local et CI (meme commandes, memes criteres d echec).
- Les findings doivent etre normalises avec severite explicite.
- Le quality gate doit echouer sur findings High/Critical non justifies.
- Les rapports doivent etre archivables pour preuve de conformite operationnelle.

### Architecture Compliance

- Respecter l architecture existante et outillage actuel:
  - backend Python 3.13 + FastAPI,
  - frontend React,
  - quality gate centralise dans `scripts/quality-gate.ps1`.
- Reutiliser les patterns de hardening deja implementes en 9.1 (pas de duplication de mecanisme).
- Eviter tout couplage fort a un fournisseur unique de scan non necessaire.

### Library / Framework Requirements

- Backend tooling securite compatible Python 3.13.
- Frontend tooling securite compatible Node/NPM du projet.
- Prioriser des outils standard, scriptables et maintenus activement.

### File Structure Requirements

- Cibles probables:
  - `scripts/quality-gate.ps1` (integration gates securite)
  - `scripts/predeploy-check.ps1` (validation avant deploiement)
  - `scripts/` (nouveaux scripts de scan si necessaire)
  - `backend/README.md` et/ou `README.md` (how-to execution scans)
  - `_bmad-output/planning-artifacts/` (rapport synthese + plan remediation)
  - `backend/app/tests/integration/` (tests d execution et comportements gate)

### Testing Requirements

- Tests minimaux attendus:
  - execution des scans securite via scripts normalises,
  - echec gate sur severite critique,
  - succes gate apres remediation ou justification explicite,
  - conservation des artefacts de sortie.

### Previous Story Intelligence

- 9.1 a deja introduit un scan anti-secrets et un quality gate robuste.
- Ne pas recreer un second pipeline parallele: etendre l existant.
- Conserver le principe d allowlist stricte (exact match) pour limiter les faux positifs permissifs.

### Git Intelligence Summary

- Le lot Epic 9 est en durcissement progressif apres mise a niveau ops/quality (Epic 8).
- Le prochain increment securite doit rester incrementale, testable, et sans rupture des flux existants.

### Latest Tech Information

- Les scanners retenus doivent privilegier:
  - support CI stable,
  - sortie machine-readable (JSON/SARIF),
  - severite exploitable pour policy gate.
- Toute selection d outil doit inclure version pinnee et justification concise.

### Project Context Reference

- `AGENTS.md` impose:
  - activation venv pour toute commande Python,
  - lint/tests obligatoires avant conclusion.
- Les standards qualite projet sont deja portes par `scripts/quality-gate.ps1`.

### References

- `_bmad-output/planning-artifacts/epics.md` (Epic 9, Story 9.2)
- `_bmad-output/planning-artifacts/architecture.md` (sections Security, Reliability, Process Patterns)
- `_bmad-output/planning-artifacts/prd.md` (NFR5..NFR9, NFR18, FR33)
- `_bmad-output/implementation-artifacts/9-1-durcissement-de-la-gestion-des-secrets-et-rotation.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

## Dev Agent Record

### Agent Model Used

GPT-5 Codex

### Debug Log References

- `_bmad/bmm/workflows/4-implementation/create-story/workflow.yaml`
- `_bmad/bmm/workflows/4-implementation/create-story/instructions.xml`
- `_bmad-output/planning-artifacts/epics.md`
- `_bmad-output/planning-artifacts/architecture.md`
- `_bmad-output/planning-artifacts/prd.md`
- `_bmad-output/implementation-artifacts/sprint-status.yaml`

### Completion Notes List

- Implementation d un pack securite unifie dans `scripts/security-verification.ps1` (SAST + deps + synthese remediation).
- Integration du pack au `quality-gate` avec policy bloquante sur severites `high/critical`.
- Scans dependances Node executes en mode `--omit=dev` par defaut pour eviter blocage sur dev-only CVE.
- Ajout de tests d integration PowerShell avec fixtures pour valider:
  - succes non-bloquant,
  - echec sur finding critique,
  - suppression via allowlist.
- Mise a jour des tests pipeline pour refl√©ter le nouveau step securite dans l ordre d execution.
- Quality gate complet valide apres changements.

### File List

- `_bmad-output/implementation-artifacts/9-2-pack-de-verification-securite-sast-deps-pentest.md`
- `scripts/security-verification.ps1`
- `scripts/security-findings-allowlist.txt`
- `scripts/quality-gate.ps1`
- `backend/pyproject.toml`
- `backend/README.md`
- `backend/app/tests/integration/test_security_verification_script.py`
- `backend/app/tests/integration/test_pipeline_scripts.py`
