---
title: FE-14 — Checkout form: AB + trial + coupons + tax address/ids
labels: frontend, billing, stripe, priority:high
assignees: 
  - 
created: 2025-11-03
---

# FE-14 — Checkout form: AB + trial + coupons + tax address/ids

## Contexte

Étendre le flux Checkout pour accepter A/B bucket (dev-only), trial, coupon, address & tax_ids quand activés par flags. Redirection vers l’URL Checkout renvoyée par le backend.

## Objectif

- Mettre en œuvre checkout form: ab + trial + coupons + tax address/ids pour aligner le front sur l'API backend Stripe.
- Offrir une UX claire, résiliente et testable.

## Portée / Hors-périmètre

- **Dans le scope** : Checkout form: AB + trial + coupons + tax address/ids.
- **Hors scope** : pricing logic côté backend, routes Stripe Server/webhooks (déjà gérées au backend).

## Design & Implémentation

- Dossier(s) impactés: `src/services/billing/*`, `src/components/billing/*`, `src/pages/billing/*`, `src/routes/*` (à adapter).
- Tech: React + TS, Zustand (si store), Zod pour validation, MSW pour tests.

### Tâches de dev

- [ ] Étendre `BillingService.createCheckoutSession(payload)` avec `{ plan, ab_bucket, trial_days?, coupon?, address?, tax_ids? }`.
- [ ] Créer `UpgradeModal` (ou étendre) avec champs conditionnels selon flags (trial/coupon/tax).
- [ ] Normaliser `ab_bucket` (`'a'|'b'` → `'A'|'B'`, sinon `null`), visible seulement en dev.
- [ ] Générer une Idempotency-Key par soumission.
- [ ] Redirection `window.location.href = checkout_url` sur 200.
- [ ] Gestion d’erreurs 4xx/5xx (toast + conseils).

### Accessibilité & i18n

- Labels et descriptions accessibles (ARIA si modal).
- Texte FR prêt pour i18n.

### Observabilité

- Logger `request_id` (si header) dans un EventBus local (dev-only) pour corrélation.

## Tests

**Unit**

- [ ] Zod schema du payload (types optionnels/obligatoires).
- [ ] Masquage de champs quand flags off.
- [ ] Normalisation du bucket.

**MSW**

- [ ] 200 → renvoie `checkout_url` et la redirection est effectuée.
- [ ] 400 plan inconnu / bucket invalide → message d’erreur clair.
- [ ] 500 clé Stripe non configurée → message dev-only.

**E2E**

- [ ] Upgrade vers Plus avec coupon (flag on) → success page visible ensuite.

## Critères d’acceptation (AC)

- Le formulaire apparaît avec les champs permis par les flags.
- La redirection Checkout fonctionne et les erreurs sont gérées.

## Sécurité

- Idempotency-Key générée côté front pour toutes mutations.
- Ne jamais exposer de clés secrètes Stripe (utiliser les endpoints backend).

## Risques / Mitigations

- Erreurs de whitelist d’URL retour: message explicite + fallback configuré.
- Flags désactivés: champs masqués proprement.

## PR attendue

**Title**: feat(front-billing): enriched checkout form (AB/trial/coupon/tax)  
**Body** (exemple à adapter) :

```
feat(front-billing): enriched checkout form (AB/trial/coupon/tax)

Contexte
- Implémente FE-14: Checkout form: AB + trial + coupons + tax address/ids.
- Aligne le front avec les endpoints backend Stripe.

Changements principaux
- [x] Composants/Service
- [x] Validation Zod
- [x] Feature flags respectés

Tests
- Unitaires (Vitest)
- MSW
- E2E (Playwright)

Docs
- README front mis à jour si applicable

Closes: <numéro de l'issue>
```

**Checklist PR**

- [ ] Lint/Typecheck ok
- [ ] Tests unitaires ok
- [ ] E2E scénarios clés ok (local)
- [ ] Docs mises à jour
- [ ] Pas d’infos sensibles dans les logs

## Références

- BILLING_DEV_SETUP.md (champs attendus backend)
- CONFIGURATION.md (flags trial/coupon/tax)
